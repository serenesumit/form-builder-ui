<div class="form-renderer-container">
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading form...</p>
    </div>
  } @else {
    <div class="form-header">
      <div class="form-title">
        <h1>{{ formData()?.name || 'Form' }}</h1>
        @if (formData()?.description) {
          <p class="form-description">{{ formData().description }}</p>
        }
      </div>
      <div class="view-mode-toggle">
        <button type="button" class="toggle-btn" (click)="toggleViewMode()">
          <span class="toggle-icon">{{ viewMode() === 'single' ? 'üìë' : 'üìÑ' }}</span>
          {{ viewMode() === 'single' ? 'Switch to Tabs View' : 'Switch to Single Page' }}
        </button>
      </div>
      <div class="progress-indicator">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progress()"></div>
        </div>
        <span class="progress-text">{{ progress() }}% Complete</span>
      </div>
    </div>

    @if (viewMode() === 'tabs' && sections().length > 1) {
      <div class="tabs-navigation">
        <div class="tabs-list">
          @for (section of sections(); track section.id; let i = $index) {
            <button
              type="button"
              class="tab-button"
              [class.active]="currentTabIndex() === i"
              (click)="goToTab(i)">
              {{ section.sectionTitle }}
            </button>
          }
        </div>
      </div>
    }

    <div class="form-content" [class.scrollable]="viewMode() === 'single'" [class.tabs-view]="viewMode() === 'tabs'">
      @for (section of sections(); track section.id; let i = $index) {
        @if (viewMode() === 'single' || i === currentTabIndex()) {
          <div class="form-section">
          <div class="section-header">
            <h2>{{ section.sectionTitle }}</h2>
            @if (section.description) {
              <p class="section-description">{{ section.description }}</p>
            }
          </div>

          <div class="section-questions">
            @for (question of section.questions; track question.id) {
              @if (isQuestionVisible(question) && question.questionTypeId !== QuestionType.Hidden) {
                <div class="question-item" 
                     [class.required]="question.isRequired"
                     [class.display-only]="isDisplayOnlyType(question)">
                  
                  <!-- Only show label for non-display-only types -->
                  @if (!isDisplayOnlyType(question)) {
                    <label class="question-label">
                      {{ question.questionText }}
                      @if (question.isRequired) {
                        <span class="required-indicator">*</span>
                      }
                    </label>

                    @if (question.helpText) {
                      <p class="help-text">{{ question.helpText }}</p>
                    }
                  }

                  <div class="question-input">
                    @switch (question.questionType) {
                      @case ('TEXT') {
                        <input
                          type="text"
                          class="form-input"
                          [value]="getAnswer(question.id) || ''"
                          (input)="updateAnswer(question.id, $any($event.target).value)"
                          [required]="question.isRequired"
                        />
                      }
                      @case ('TEXTAREA') {
                        <textarea
                          class="form-textarea"
                          rows="4"
                          [value]="getAnswer(question.id) || ''"
                          (input)="updateAnswer(question.id, $any($event.target).value)"
                          [required]="question.isRequired"
                        ></textarea>
                      }
                      @case ('NUMBER') {
                        <input
                          type="number"
                          class="form-input"
                          [value]="getAnswer(question.id) || ''"
                          (input)="updateAnswer(question.id, $any($event.target).value)"
                          [required]="question.isRequired"
                        />
                      }
                      @case ('DATE') {
                        <input
                          type="date"
                          class="form-input"
                          [value]="getAnswer(question.id) || ''"
                          (input)="updateAnswer(question.id, $any($event.target).value)"
                          [required]="question.isRequired"
                        />
                      }
                      @case ('TIME') {
                        <input
                          type="time"
                          class="form-input"
                          [value]="getAnswer(question.id) || ''"
                          (input)="updateAnswer(question.id, $any($event.target).value)"
                          [required]="question.isRequired"
                        />
                      }
                      @case ('DATETIME') {
                        <input
                          type="datetime-local"
                          class="form-input"
                          [value]="getAnswer(question.id) || ''"
                          (input)="updateAnswer(question.id, $any($event.target).value)"
                          [required]="question.isRequired"
                        />
                      }
                      @case ('YESNO') {
                        <div class="yesno-group">
                          <label class="radio-option">
                            <input
                              type="radio"
                              [name]="question.id"
                              value="true"
                              [checked]="getAnswer(question.id) === 'true'"
                              (change)="updateAnswer(question.id, 'true')"
                            />
                            <span>Yes</span>
                          </label>
                          <label class="radio-option">
                            <input
                              type="radio"
                              [name]="question.id"
                              value="false"
                              [checked]="getAnswer(question.id) === 'false'"
                              (change)="updateAnswer(question.id, 'false')"
                            />
                            <span>No</span>
                          </label>
                        </div>
                      }
                      @case ('SINGLE_CHOICE') {
                        <div class="radio-group">
                          @for (option of question.options; track option.id) {
                            <label class="radio-option">
                              <input
                                type="radio"
                                [name]="question.id"
                                [value]="option.optionValue"
                                [checked]="getAnswer(question.id) === option.optionValue"
                                (change)="updateAnswer(question.id, option.optionValue, option.id)"
                              />
                              <span>{{ option.optionText }}</span>
                            </label>
                          }
                        </div>
                      }
                      @case ('RADIOBUTTON') {
                        <div class="radio-group">
                          @for (option of question.options; track option.id) {
                            <label class="radio-option">
                              <input
                                type="radio"
                                [name]="question.id"
                                [value]="option.optionValue"
                                [checked]="getAnswer(question.id) === option.optionValue"
                                (change)="updateAnswer(question.id, option.optionValue, option.id)"
                              />
                              <span>{{ option.optionText }}</span>
                            </label>
                          }
                        </div>
                      }
                      @case ('MULTIPLE_CHOICE') {
                        <div class="checkbox-group">
                          @for (option of question.options; track option.id) {
                            <label class="checkbox-option">
                              <input
                                type="checkbox"
                                [value]="option.optionValue"
                                (change)="updateAnswer(question.id, option.optionValue, option.id)"
                              />
                              <span>{{ option.optionText }}</span>
                            </label>
                          }
                        </div>
                      }
                      @case ('DROPDOWN') {
                        <select
                          class="form-select"
                          [value]="getAnswer(question.id) || ''"
                          (change)="updateAnswer(question.id, $any($event.target).value)"
                          [required]="question.isRequired"
                        >
                          <option value="">Select an option</option>
                          @for (option of question.options; track option.id) {
                            <option [value]="option.optionValue">{{ option.optionText }}</option>
                          }
                        </select>
                      }
                      @case ('SLIDER') {
                        <div class="slider-container">
                          <input
                            type="range"
                            class="form-slider"
                            [min]="question.minValue || 0"
                            [max]="question.maxValue || 100"
                            [value]="getAnswer(question.id) || question.minValue || 0"
                            (input)="updateAnswer(question.id, $any($event.target).value)"
                          />
                          <span class="slider-value">{{ getAnswer(question.id) || question.minValue || 0 }}</span>
                        </div>
                      }
                      @case ('SCALE') {
                        <div class="scale-group">
                          @for (num of getScaleOptions(question); track num) {
                            <button
                              type="button"
                              class="scale-option"
                              [class.selected]="getAnswer(question.id) === num.toString()"
                              (click)="updateAnswer(question.id, num.toString())">
                              {{ num }}
                            </button>
                          }
                        </div>
                      }
                      @case ('MATRIX') {
                        <div class="matrix-table">
                          @if (question.matrixRows?.length && question.matrixCols?.length) {
                            <table>
                              <thead>
                                <tr>
                                  <th></th>
                                  @for (col of question.matrixCols; track col.id) {
                                    <th>{{ col.colLabel || col.colText }}</th>
                                  }
                                </tr>
                              </thead>
                              <tbody>
                                @for (row of question.matrixRows; track row.id) {
                                  <tr>
                                    <td class="row-label">{{ row.rowLabel || row.rowText }}</td>
                                    @for (col of question.matrixCols; track col.id) {
                                      <td>
                                        @switch (col.inputType || 'radio') {
                                          @case ('radio') {
                                            <input
                                              type="radio"
                                              [name]="question.id + '_' + row.id"
                                              [value]="col.id"
                                              (change)="updateMatrixAnswer(question.id, row.id, col.id, 'selected')"
                                              [checked]="getMatrixAnswer(question.id, row.id, col.id) === 'selected'"
                                            />
                                          }
                                          @case ('checkbox') {
                                            <input
                                              type="checkbox"
                                              [name]="question.id + '_' + row.id + '_' + col.id"
                                              (change)="updateMatrixAnswer(question.id, row.id, col.id, $any($event.target).checked ? 'checked' : '')"
                                              [checked]="getMatrixAnswer(question.id, row.id, col.id) === 'checked'"
                                            />
                                          }
                                          @case ('text') {
                                            <input
                                              type="text"
                                              [name]="question.id + '_' + row.id + '_' + col.id"
                                              [value]="getMatrixAnswer(question.id, row.id, col.id) || ''"
                                              (input)="updateMatrixAnswer(question.id, row.id, col.id, $any($event.target).value)"
                                              class="matrix-text-input"
                                            />
                                          }
                                          @case ('number') {
                                            <input
                                              type="number"
                                              [name]="question.id + '_' + row.id + '_' + col.id"
                                              [value]="getMatrixAnswer(question.id, row.id, col.id) || ''"
                                              (input)="updateMatrixAnswer(question.id, row.id, col.id, $any($event.target).value)"
                                              class="matrix-number-input"
                                            />
                                          }
                                          @case ('dropdown') {
                                            <select
                                              [name]="question.id + '_' + row.id + '_' + col.id"
                                              [value]="getMatrixAnswer(question.id, row.id, col.id) || ''"
                                              (change)="updateMatrixAnswer(question.id, row.id, col.id, $any($event.target).value)"
                                              class="matrix-dropdown">
                                              <option value="">Select...</option>
                                              @if (col.options) {
                                                @for (option of col.options; track option.id) {
                                                  <option [value]="option.optionValue || option.value">
                                                    {{ option.optionText || option.text }}
                                                  </option>
                                                }
                                              }
                                            </select>
                                          }
                                        }
                                      </td>
                                    }
                                  </tr>
                                }
                              </tbody>
                            </table>
                          } @else {
                            <div class="empty-state">Matrix not configured</div>
                          }
                        </div>
                      }
                      @case ('TABLE') {
                        <div class="data-table">
                          @if (question.rows?.length && question.cols?.length) {
                            <table>
                              <thead>
                                <tr>
                                  <th></th>
                                  @for (col of question.cols; track col.colId || col.colCode) {
                                    <th>{{ col.colLabel }}</th>
                                  }
                                </tr>
                              </thead>
                              <tbody>
                                @for (row of question.rows; track row.rowId || row.rowCode) {
                                  <tr>
                                    <td class="row-label">{{ row.rowLabel }}</td>
                                    @for (col of question.cols; track col.colId || col.colCode) {
                                      <td>
                                        @switch (col.inputType) {
                                          @case ('text') {
                                            <input type="text" class="table-input" placeholder="..." />
                                          }
                                          @case ('number') {
                                            <input type="number" class="table-input" placeholder="0" />
                                          }
                                          @case ('radio') {
                                            <input type="radio" [name]="question.id + '_' + (row.rowId || row.rowCode)" />
                                          }
                                          @case ('checkbox') {
                                            <input type="checkbox" />
                                          }
                                          @case ('dropdown') {
                                            <select class="table-select">
                                              <option value="">Select...</option>
                                            </select>
                                          }
                                          @default {
                                            <input type="text" class="table-input" placeholder="..." />
                                          }
                                        }
                                      </td>
                                    }
                                  </tr>
                                }
                              </tbody>
                            </table>
                          } @else {
                            <div class="empty-state">Table not configured</div>
                          }
                        </div>
                      }
                      @case ('RICHTEXT') {
                        <div class="richtext-display" [innerHTML]="question.questionText"></div>
                      }
                      @case ('DISPLAY') {
                        <div class="display-content" [innerHTML]="question.questionText"></div>
                      }
                      @case ('CALCULATED') {
                        <div class="calculated-field">
                          <span class="calc-icon">üî¢</span>
                          <span class="calc-value">{{ getAnswer(question.id) || question.defaultValue || '‚Äî' }}</span>
                          @if (question.calculationExpression) {
                            <p class="calc-formula">Formula: {{ question.calculationExpression }}</p>
                          }
                        </div>
                      }
                    }
                  </div>
                </div>
              }
            }
          </div>

          @if (viewMode() === 'tabs') {
            <div class="tab-navigation-buttons">
              <button
                type="button"
                class="nav-btn nav-prev"
                [disabled]="currentTabIndex() === 0"
                (click)="previousTab()">
                ‚Üê Previous
              </button>
              <button
                type="button"
                class="nav-btn nav-next"
                [disabled]="currentTabIndex() === sections().length - 1"
                (click)="nextTab()">
                Next ‚Üí
              </button>
            </div>
          }
        </div>
        }
      }
    </div>

    <div class="form-actions">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="saveDraft()"
        [disabled]="saving()"
      >
        {{ saving() ? 'Saving...' : 'Save Draft' }}
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="submitForm()"
        [disabled]="saving()"
      >
        {{ saving() ? 'Submitting...' : 'Submit Form' }}
      </button>
    </div>
  }
</div>
