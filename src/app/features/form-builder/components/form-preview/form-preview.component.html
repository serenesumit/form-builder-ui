<div class="form-preview">
  <div class="form-preview-header">
    <h2 class="form-preview-title">Form Preview</h2>
    @if (readonly) {
      <div class="readonly-badge">Read Only Mode</div>
    }
  </div>

  <div class="sections-container">
    @for (section of getSortedSections(); track section.sectionId) {
      @if (getSectionQuestions(section.sectionId).length > 0) {
        <div class="section-container">
          <h3 class="section-title">{{ section.sectionName }}</h3>
          @if (section.sectionDescription) {
            <p class="section-description">{{ section.sectionDescription }}</p>
          }

          <div class="questions-container">
            @for (question of getSectionQuestions(section.sectionId); track question.questionId) {
              <!-- Skip hidden fields entirely -->
              @if (question.questionTypeId !== QuestionType.Hidden) {
              <div class="question-item"
                   [class.display-only]="isDisplayOnlyType(question.questionTypeId)"
                   [style.background-color]="question.backgroundColor || 'transparent'"
                   [style.border-color]="question.borderColor || '#e5e7eb'"
                   [style.min-height.px]="question.height || 'auto'">

                <!-- Only show label for non-display-only types -->
                @if (!isDisplayOnlyType(question.questionTypeId)) {
                  <label class="question-label">
                    {{ question.questionText }}
                    @if (question.isRequired) {
                      <span class="required-indicator">*</span>
                    }
                  </label>

                  @if (question.helpText) {
                    <p class="help-text">{{ question.helpText }}</p>
                  }
                }

                <!-- Text Input -->
                @if (question.questionTypeId === QuestionType.Text) {
                  <ejs-textbox
                    [value]="getQuestionValue(question.questionId)"
                    (input)="handleQuestionChange(question.questionId, $any($event.target).value)"
                    [placeholder]="question.placeholderText || ''"
                    [readonly]="readonly"
                    [enabled]="!readonly"
                    cssClass="form-control">
                  </ejs-textbox>
                }

                <!-- TextArea Input -->
                @if (question.questionTypeId === QuestionType.TextArea) {
                  <ejs-textbox
                    [value]="getQuestionValue(question.questionId)"
                    (input)="handleQuestionChange(question.questionId, $any($event.target).value)"
                    [placeholder]="question.placeholderText || ''"
                    [multiline]="true"
                    [readonly]="readonly"
                    [enabled]="!readonly"
                    cssClass="form-control">
                  </ejs-textbox>
                }

                <!-- Number Input -->
                @if (question.questionTypeId === QuestionType.Number) {
                  <ejs-numerictextbox
                    [value]="getQuestionValue(question.questionId)"
                    (change)="handleQuestionChange(question.questionId, $event.value)"
                    [placeholder]="question.placeholderText || ''"
                    [min]="question.minValue ?? undefined"
                    [max]="question.maxValue ?? undefined"
                    [readonly]="readonly"
                    [enabled]="!readonly"
                    cssClass="form-control">
                  </ejs-numerictextbox>
                }


                <!-- Date Picker -->
                @if (question.questionTypeId === QuestionType.Date) {
                  <ejs-datepicker
                    [value]="getQuestionValue(question.questionId)"
                    (change)="handleQuestionChange(question.questionId, $event.value)"
                    [placeholder]="question.placeholderText || 'Select date'"
                    [readonly]="readonly"
                    [enabled]="!readonly"
                    cssClass="form-control">
                  </ejs-datepicker>
                }

                <!-- Time Picker -->
                @if (question.questionTypeId === QuestionType.Time) {
                  <ejs-timepicker
                    [value]="getQuestionValue(question.questionId)"
                    (change)="handleQuestionChange(question.questionId, $event.value)"
                    [placeholder]="question.placeholderText || 'Select time'"
                    [readonly]="readonly"
                    [enabled]="!readonly"
                    cssClass="form-control">
                  </ejs-timepicker>
                }

                <!-- DateTime Picker -->
                @if (question.questionTypeId === QuestionType.DateTime) {
                  <ejs-datetimepicker
                    [value]="getQuestionValue(question.questionId)"
                    (change)="handleQuestionChange(question.questionId, $event.value)"
                    [placeholder]="question.placeholderText || 'Select date and time'"
                    [readonly]="readonly"
                    [enabled]="!readonly"
                    cssClass="form-control">
                  </ejs-datetimepicker>
                }


                <!-- Checkboxes -->
                @if (question.questionTypeId === QuestionType.Checkbox) {
                  <div class="options-container">
                    @for (option of question.options; track option.optionId) {
                      <div class="option-item">
                        <ejs-checkbox
                          [label]="option.optionText"
                          [value]="option.optionValue || option.optionText"
                          [checked]="isCheckboxSelected(question.questionId, option.optionValue || option.optionText)"
                          (change)="handleCheckboxChange(question.questionId, option.optionValue || option.optionText, $event.checked)"
                          [disabled]="readonly">
                        </ejs-checkbox>
                      </div>
                    }
                  </div>
                }

                <!-- Dropdown -->
                @if (question.questionTypeId === QuestionType.Dropdown) {
                  <ejs-dropdownlist
                    [dataSource]="question.options"
                    [fields]="getDropdownFields()"
                    [value]="getQuestionValue(question.questionId)"
                    (change)="handleQuestionChange(question.questionId, $event.value)"
                    [placeholder]="question.placeholderText || 'Select an option'"
                    [readonly]="readonly"
                    [enabled]="!readonly"
                    cssClass="form-control">
                  </ejs-dropdownlist>
                }

                <!-- Slider -->
                @if (question.questionTypeId === QuestionType.Slider) {
                  <div class="slider-container">
                    <ejs-slider
                      [value]="getQuestionValue(question.questionId) || question.minValue || 0"
                      (change)="handleQuestionChange(question.questionId, $event.value)"
                      [min]="question.minValue || 0"
                      [max]="question.maxValue || 100"
                      [readonly]="readonly"
                      [enabled]="!readonly"
                      [showButtons]="true"
                      [tooltip]="{isVisible: true, placement: 'Before', showOn: 'Always'}"
                      cssClass="form-control">
                    </ejs-slider>
                  </div>
                }

                <!-- Rating / Scale -->
                @if (question.questionTypeId === QuestionType.Scale) {
                  <div class="scale-container">
                    @for (num of getScaleOptions(question); track num) {
                      <button
                        type="button"
                        class="scale-option"
                        [class.selected]="getQuestionValue(question.questionId) === num"
                        [disabled]="readonly"
                        (click)="handleQuestionChange(question.questionId, num)">
                        {{ num }}
                      </button>
                    }
                  </div>
                }

                <!-- Yes/No -->
                @if (question.questionTypeId === QuestionType.YesNo) {
                  <div class="yesno-container">
                    <ejs-radiobutton
                      label="Yes"
                      [name]="question.questionId + '_yesno'"
                      value="true"
                      [checked]="getQuestionValue(question.questionId) === true || getQuestionValue(question.questionId) === 'true'"
                      (change)="handleQuestionChange(question.questionId, true)"
                      [disabled]="readonly">
                    </ejs-radiobutton>
                    <ejs-radiobutton
                      label="No"
                      [name]="question.questionId + '_yesno'"
                      value="false"
                      [checked]="getQuestionValue(question.questionId) === false || getQuestionValue(question.questionId) === 'false'"
                      (change)="handleQuestionChange(question.questionId, false)"
                      [disabled]="readonly">
                    </ejs-radiobutton>
                  </div>
                }

                <!-- Multiple Choice (Single Select) -->
                @if (question.questionTypeId === QuestionType.MultipleChoice) {
                  <div class="options-container">
                    @for (option of question.options; track option.optionId) {
                      <div class="option-item">
                        <ejs-radiobutton
                          [label]="option.optionText"
                          [name]="question.questionId"
                          [value]="option.optionValue || option.optionText"
                          [checked]="getQuestionValue(question.questionId) === (option.optionValue || option.optionText)"
                          (change)="handleQuestionChange(question.questionId, option.optionValue || option.optionText)"
                          [disabled]="readonly">
                        </ejs-radiobutton>
                      </div>
                    }
                  </div>
                }

                <!-- Radio Button -->
                @if (question.questionTypeId === QuestionType.RadioButton) {
                  <div class="options-container">
                    @for (option of question.options; track option.optionId) {
                      <div class="option-item">
                        <ejs-radiobutton
                          [label]="option.optionText"
                          [name]="question.questionId"
                          [value]="option.optionValue || option.optionText"
                          [checked]="getQuestionValue(question.questionId) === (option.optionValue || option.optionText)"
                          (change)="handleQuestionChange(question.questionId, option.optionValue || option.optionText)"
                          [disabled]="readonly">
                        </ejs-radiobutton>
                      </div>
                    }
                  </div>
                }

                <!-- Matrix -->
                @if (question.questionTypeId === QuestionType.Matrix) {
                  <div class="matrix-container">
                    @if (question.rows?.length && question.cols?.length) {
                      <div class="matrix-table-wrapper">
                        <table class="matrix-table">
                          <thead>
                            <tr>
                              <th class="matrix-header-cell"></th>
                              @for (col of question.cols; track col.colId || col.colCode) {
                                <th class="matrix-header-cell">{{ col.colLabel }}</th>
                              }
                            </tr>
                          </thead>
                          <tbody>
                            @for (row of question.rows; track row.rowId || row.rowCode) {
                              <tr>
                                <td class="matrix-row-label">{{ row.rowLabel }}</td>
                                @for (col of question.cols; track col.colId || col.colCode) {
                                  <td class="matrix-cell">
                                    <input
                                      type="radio"
                                      [name]="question.questionId + '_' + (row.rowId || row.rowCode)"
                                      [disabled]="readonly"
                                      class="matrix-radio">
                                  </td>
                                }
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    } @else {
                      <div class="matrix-empty-state">
                        <span class="empty-icon">‚ö†Ô∏è</span>
                        <p>Matrix not configured. Add rows and columns in the editor.</p>
                      </div>
                    }
                  </div>
                }

                <!-- Table -->
                @if (question.questionTypeId === QuestionType.Table) {
                  <div class="table-container">
                    @if (question.rows?.length && question.cols?.length) {
                      <div class="data-table-wrapper">
                        <table class="data-table">
                          <thead>
                            <tr>
                              <th class="table-header-cell"></th>
                              @for (col of question.cols; track col.colId || col.colCode) {
                                <th class="table-header-cell">{{ col.colLabel }}</th>
                              }
                            </tr>
                          </thead>
                          <tbody>
                            @for (row of question.rows; track row.rowId || row.rowCode) {
                              <tr>
                                <td class="table-row-label">{{ row.rowLabel }}</td>
                                @for (col of question.cols; track col.colId || col.colCode) {
                                  <td class="table-cell">
                                    @switch (col.inputType) {
                                      @case ('text') {
                                        <input type="text" class="table-input" [disabled]="readonly" placeholder="...">
                                      }
                                      @case ('number') {
                                        <input type="number" class="table-input" [disabled]="readonly" placeholder="0">
                                      }
                                      @case ('radio') {
                                        <input type="radio" [name]="question.questionId + '_' + (row.rowId || row.rowCode)" [disabled]="readonly">
                                      }
                                      @case ('checkbox') {
                                        <input type="checkbox" [disabled]="readonly">
                                      }
                                      @case ('dropdown') {
                                        <select class="table-select" [disabled]="readonly">
                                          <option value="">Select...</option>
                                        </select>
                                      }
                                      @default {
                                        <input type="text" class="table-input" [disabled]="readonly" placeholder="...">
                                      }
                                    }
                                  </td>
                                }
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    } @else {
                      <div class="table-empty-state">
                        <span class="empty-icon">üìä</span>
                        <p>Table not configured. Add rows and columns in the editor.</p>
                      </div>
                    }
                  </div>
                }

                <!-- Rich Text Block (Display Only) -->
                @if (question.questionTypeId === QuestionType.RichTextBlock) {
                  <div class="richtext-block" [innerHTML]="question.questionText"></div>
                }

                <!-- Display (Info Text) -->
                @if (question.questionTypeId === QuestionType.Display) {
                  <div class="display-block" [innerHTML]="question.questionText"></div>
                }

                <!-- Calculated Field -->
                @if (question.questionTypeId === QuestionType.Calculated) {
                  <div class="calculated-field">
                    <div class="calculated-value">
                      <span class="calc-icon">üî¢</span>
                      <span class="calc-result">{{ getQuestionValue(question.questionId) || '‚Äî' }}</span>
                    </div>
                    @if (question.calculationExpression) {
                      <p class="calc-formula">Formula: {{ question.calculationExpression }}</p>
                    }
                  </div>
                }

                <!-- Error Message -->
                @if (getError(question.questionId)) {
                  <div class="error-message">{{ getError(question.questionId) }}</div>
                }
              </div>
              } <!-- End of hidden field check -->
            }
          </div>
        </div>
      }
    }
  </div>

  @if (!readonly) {
    <div class="form-actions">
      <button class="submit-button" (click)="handleSubmit()">
        Submit Form
      </button>
    </div>
  }
</div>
