<div class="form-canvas" (click)="onClearCanvas()">
  <div class="canvas-header">
    <div class="canvas-title">
      <h2>Form Canvas</h2>
      <span class="question-count">
        {{ store.totalQuestions() }} question{{ store.totalQuestions() === 1 ? '' : 's' }}
      </span>
    </div>
    <button class="add-section-btn" (click)="onAddSection()" type="button">
      <span class="material-icons">add</span>
      Add Section
    </button>
  </div>

  @if (store.sections().length === 0) {
    <div class="empty-canvas">
      <div class="empty-icon">
        <span class="material-icons">dashboard_customize</span>
      </div>
      <h3>Start Building Your Form</h3>
      <p>Drag components from the palette on the left, or click "Add Section" to get started.</p>
      <button class="start-btn" (click)="onAddSection()" type="button">
        <span class="material-icons">add_circle</span>
        Create First Section
      </button>
    </div>
  } @else {
    <div 
      class="sections-container"
      cdkDropList
      cdkDropListOrientation="vertical"
      [cdkDropListData]="store.sections()"
      (cdkDropListDropped)="onSectionDrop($event)">
      
      @for (section of store.sections(); track section.id; let sectionIndex = $index) {
        <div 
          class="canvas-section"
          cdkDrag
          [cdkDragData]="section"
          [class.selected]="isSectionSelected(sectionIndex)"
          [class.collapsed]="section.isCollapsed"
          (click)="onSelectSection(sectionIndex, $event)">
          
          <div class="section-drag-handle" cdkDragHandle>
            <span class="material-icons">drag_indicator</span>
          </div>

          <div class="section-header">
            <div class="section-info">
              <button 
                class="collapse-btn"
                (click)="onToggleSectionCollapse(sectionIndex, $event)"
                type="button">
                <span class="material-icons">
                  {{ section.isCollapsed ? 'expand_more' : 'expand_less' }}
                </span>
              </button>
              <div class="section-title">
                <h3>{{ section.name }}</h3>
                <span class="section-meta">
                  {{ section.questions.length }} question{{ section.questions.length === 1 ? '' : 's' }}
                  @if (section.isRepeatable) {
                    <span class="repeatable-badge">Repeatable</span>
                  }
                </span>
              </div>
            </div>
            <div class="section-actions">
              <button 
                class="section-action-btn delete"
                (click)="onDeleteSection(sectionIndex, $event)"
                title="Delete section"
                type="button">
                <span class="material-icons">delete_outline</span>
              </button>
            </div>
          </div>

          @if (!section.isCollapsed) {
            <div 
              class="section-content"
              cdkDropList
              [id]="'section-' + sectionIndex"
              [cdkDropListData]="section.questions"
              [cdkDropListConnectedTo]="getAllDropListIds()"
              (cdkDropListDropped)="onQuestionDrop($event, sectionIndex)">
              
              @if (section.questions.length === 0) {
                <div class="empty-section-drop">
                  <span class="material-icons">add_circle_outline</span>
                  <p>Drag a component here</p>
                </div>
              } @else {
                @for (question of section.questions; track question.id; let questionIndex = $index) {
                  <div 
                    cdkDrag 
                    [cdkDragData]="question"
                    class="question-wrapper">
                    <app-sortable-question
                      [question]="question"
                      [sectionIndex]="sectionIndex"
                      [questionIndex]="questionIndex"
                      [isSelected]="isQuestionSelected(sectionIndex, questionIndex)"
                      (selectQuestion)="onSelectQuestion($event)"
                      (deleteQuestion)="onDeleteQuestion($event)"
                      (duplicateQuestion)="onDuplicateQuestion($event)">
                    </app-sortable-question>
                    <div class="question-placeholder" *cdkDragPlaceholder></div>
                  </div>
                }
              }
            </div>
          }
        </div>
      }
    </div>
  }
</div>

